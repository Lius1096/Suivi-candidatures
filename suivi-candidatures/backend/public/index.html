<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi des candidatures</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

</head>
<body class="bg-gray-50 p-4 sm:p-6 min-h-screen flex flex-col items-center">

  <h1 class="text-3xl font-bold text-center mb-6">Suivi des candidatures</h1>

  <!-- Message -->
  <div id="messageBox" class="hidden max-w-xl w-full mb-4 p-3 rounded border text-sm font-medium"></div>

  <!-- Formulaire -->
  <form id="candidatureForm" class="bg-white p-6 rounded-lg shadow mb-6 space-y-4 w-full max-w-xl" enctype="multipart/form-data" autocomplete="off">
    <div>
      <label for="email" class="block font-semibold mb-1">Adresse e-mail</label>
      <input type="email" id="email" name="email" required class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>
    <div>
      <label for="password" class="block font-semibold mb-1">Mot de passe</label>
      <input type="password" id="password" name="password" required class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>
    <div>
      <label for="email_entreprise" class="block font-semibold mb-1">Email de l'entreprise</label>
      <input type="email" id="email_entreprise" name="email_entreprise" required class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>
    <div>
      <label for="site_url" class="block font-semibold mb-1">URL du site</label>
      <input type="url" id="site_url" name="site_url" required class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>
    <div>
      <label for="entreprise" class="block font-semibold mb-1">Nom de l'entreprise</label>
      <input type="text" id="entreprise" name="entreprise" required class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>
    <div>
      <label for="cv" class="block font-semibold mb-1">CV (fichier PDF, DOC...)</label>
      <input type="file" id="cv" name="cv" accept=".pdf,.doc,.docx" class="w-full border border-gray-300 px-3 py-2 rounded-md" />
    </div>
    <div>
      <label for="infos_entreprise" class="block font-semibold mb-1">Infos sur l'entreprise (pour générer lettre)</label>
      <textarea id="infos_entreprise" name="infos_entreprise" rows="3" class="w-full border border-gray-300 px-3 py-2 rounded-md resize-y focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
    </div>
    <div>
      <label for="lettre_generee" class="block font-semibold mb-1">Lettre générée</label>
      <textarea id="lettre_generee" name="lettre_generee" rows="8" class="w-full border border-gray-300 px-3 py-2 rounded-md resize-y focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"></textarea>
    </div>

    <!-- Boutons -->
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
  <button type="submit" class="w-full sm:w-1/2 flex items-center justify-center px-4 py-2 rounded-lg font-semibold text-blue-700 hover:text-blue-900 transition-colors">
    <i class="fa-solid fa-plus mr-2"></i>
    Ajouter candidature
  </button>
  <button type="button" id="generateLetterBtn" class="w-full sm:w-1/2 flex items-center justify-center px-4 py-2 rounded-lg font-semibold text-emerald-700 hover:text-emerald-900 transition-colors">
    <i class="fa-solid fa-file-lines mr-2"></i>
    Générer lettre
  </button>
</div>

  </form>

  <!-- Filtrage -->
  <div class="mb-4 flex items-center space-x-2 max-w-xl w-full">
    <input type="checkbox" id="filterNoResponse" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
    <label for="filterNoResponse" class="text-sm text-gray-700 select-none">Afficher uniquement les candidatures sans réponse</label>
  </div>

  <!-- Tableau -->
  <div class="overflow-x-auto w-full max-w-6xl rounded border border-gray-200">
    <table class="min-w-full bg-white text-sm text-left">
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm">
          <th class="py-3 px-6">Email</th>
          <th class="py-3 px-6">Site</th>
          <th class="py-3 px-6">Entreprise</th>
          <th class="py-3 px-6">CV</th>
          <th class="py-3 px-6">Infos entreprise</th>
          <th class="py-3 px-6">Email entreprise</th>
          <th class="py-3 px-6">Réponse</th>
          <th class="py-3 px-6">Actions</th>
        </tr>
      </thead>
      <tbody id="candidaturesTableBody" class="text-gray-700">
        <!-- lignes JS -->
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div id="paginationControls" class="flex justify-center items-center gap-4 mt-4 max-w-6xl w-full text-sm font-medium"></div>

  <!-- Modale -->
  <div id="letterModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full shadow-lg relative">
      <button id="closeModalBtn" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 font-bold text-xl">&times;</button>
      <h2 class="text-xl font-semibold mb-4">Lettre générée</h2>
      <pre id="modalLetterContent" class="whitespace-pre-wrap bg-gray-100 p-4 rounded max-h-96 overflow-auto min-h-[150px] text-sm"></pre>
      <div id="modalLoading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center text-gray-700 text-lg font-semibold hidden">
        Chargement...
      </div>
    </div>
  </div>

<script>
  const apiBase = "http://localhost:3000/api/candidatures";
  const form = document.getElementById("candidatureForm");
  const generateBtn = document.getElementById("generateLetterBtn");
  const tableBody = document.getElementById("candidaturesTableBody");
  const filterCheckbox = document.getElementById("filterNoResponse");
  const messageBox = document.getElementById("messageBox");
  const lettreTextarea = document.getElementById("lettre_generee");

  const letterModal = document.getElementById('letterModal');
  const modalLetterContent = document.getElementById('modalLetterContent');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const modalLoading = document.getElementById('modalLoading');
  const paginationControls = document.getElementById("paginationControls");

  // Variables pagination
  let candidaturesData = [];
  let currentPage = 1;
  const pageSize = 5;

  // Affiche un message temporaire en haut
  function showMessage(text, type = "info") {
    messageBox.textContent = text;
    messageBox.className = "max-w-xl mb-4 p-3 rounded";

    if (type === "error") {
      messageBox.classList.add("bg-red-100", "text-red-800", "border", "border-red-400");
    } else if (type === "success") {
      messageBox.classList.add("bg-green-100", "text-green-800", "border", "border-green-400");
    } else {
      messageBox.classList.add("bg-blue-100", "text-blue-800", "border", "border-blue-400");
    }

    messageBox.classList.remove("hidden");

    setTimeout(() => {
      messageBox.classList.add("hidden");
    }, 4000);
  }

  // Ouvre la modale avec la lettre et gère affichage loading
  function openLetterModal(letter) {
    modalLetterContent.textContent = "";
    modalLoading.classList.remove("hidden");
    letterModal.classList.remove('hidden');

    setTimeout(() => {
      modalLoading.classList.add("hidden");
      modalLetterContent.textContent = letter && letter.trim() ? letter : "Aucune lettre disponible.";
    }, 300);
  }

  // Ferme la modale
  function closeModal() {
    letterModal.classList.add('hidden');
  }

  closeModalBtn.addEventListener('click', closeModal);
  letterModal.addEventListener('click', e => {
    if (e.target === letterModal) closeModal();
  });

  // Générer lettre basée sur infos_entreprise + entreprise
//  generateBtn.addEventListener("click", async () => {
//   const entreprise = form.entreprise.value.trim();
//   const infos = form.infos_entreprise.value.trim();
//   const cv = form.cv ? form.cv.value.trim() : ""; // s'il y a un champ CV

//   if (!entreprise || !infos) {
//     showMessage("Merci de remplir le nom de l'entreprise et les infos sur l'entreprise.", "error");
//     return;
//   }

//   try {
//     const response = await fetch("api/candidatures/generate-letter", {
//       method: "POST",
//       headers: {
//         "Content-Type": "application/json"
//       },
//       body: JSON.stringify({ entreprise, infos_entreprise: infos, cv })
//     });

//     if (!response.ok) {
//       throw new Error("Erreur lors de la génération de la lettre");
//     }

//     const data = await response.json();
//     lettreTextarea.value = data.lettre_generee || "";
//     showMessage("Lettre générée automatiquement depuis le serveur.", "success");
//   } catch (err) {
//     showMessage("Erreur lors de la génération de la lettre.", "error");
//     console.error(err);
//   }
// });

generateBtn.addEventListener("click", async () => {
  const entreprise = form.entreprise.value.trim();
  const infos = form.infos_entreprise.value.trim();
  const cvFile = form.cv.files[0];

  if (!entreprise || !infos || !cvFile) {
    showMessage("Merci de remplir le nom de l'entreprise, les infos, et de sélectionner un CV.", "error");
    return;
  }

  const formData = new FormData();
  formData.append("entreprise", entreprise);
  formData.append("infos_entreprise", infos);
  formData.append("cv", cvFile); // envoie le fichier sélectionné

  try {
    const response = await fetch("api/candidatures/generate-letter", {
      method: "POST",
      body: formData // ne pas mettre Content-Type, c’est FormData qui le gère
    });

    if (!response.ok) {
      throw new Error("Erreur lors de la génération de la lettre");
    }

    const data = await response.json();
    lettreTextarea.value = data.lettre_generee || "";
    showMessage("Lettre générée automatiquement depuis le serveur.", "success");
  } catch (err) {
    showMessage("Erreur lors de la génération de la lettre.", "error");
    console.error(err);
  }
});


 form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const entreprise = form.entreprise.value.trim();
  const infos = form.infos_entreprise.value.trim();
  const cvFile = form.cv.files[0];

  if (!entreprise || !infos || !cvFile) {
    showMessage("Merci de remplir le nom de l'entreprise, les infos, et de sélectionner un CV.", "error");
    return;
  }

  try {
    // Génération lettre avec FormData (car serveur attend fichier)
    const genFormData = new FormData();
    genFormData.append("entreprise", entreprise);
    genFormData.append("infos_entreprise", infos);
    genFormData.append("cv", cvFile);
const generateLetterUrl = "/api/candidatures/generate-letter";

    const genRes = await fetch(generateLetterUrl, {
      method: "POST",
      body: genFormData,
    });

    if (!genRes.ok) throw new Error("Erreur lors de la génération de la lettre");

    const { lettre_generee } = await genRes.json();
    lettreTextarea.value = lettre_generee;

    // Préparer et envoyer la candidature complète
    const candidatureFormData = new FormData(form);
    candidatureFormData.set("lettre_generee", lettre_generee);
    // Assure-toi que le cv est bien dans candidatureFormData, sinon le remettre
    if (!candidatureFormData.has("cv") && cvFile) {
      candidatureFormData.append("cv", cvFile);
    }

    const res = await fetch(apiBase, {
      method: "POST",
      body: candidatureFormData,
    });

    if (!res.ok) throw new Error("Erreur serveur lors de l'ajout de la candidature");

    showMessage("Candidature ajoutée avec succès", "success");
    form.reset();
    lettreTextarea.value = "";
    // Recharge la liste, fonction à définir
    fetchCandidatures();

  } catch (err) {
    showMessage(err.message || "Erreur inconnue", "error");
    console.error(err);
  }
});


  // Fonction fetch candidatures
  async function fetchCandidatures() {
    try {
      const res = await fetch(apiBase);
      if (!res.ok) throw new Error("Erreur réseau");
      const data = await res.json();
      candidaturesData = data;
      currentPage = 1;
      renderTable(candidaturesData);
    } catch (err) {
      showMessage("Erreur lors du chargement des candidatures", "error");
    }
  }

  // Rend le tableau avec pagination et filtrage
  function renderTable(candidatures) {
    const showOnlyNoResponse = filterCheckbox.checked;
    let filtered = showOnlyNoResponse
      ? candidatures.filter(c => !c.reponse)
      : candidatures;

    candidaturesData = filtered;

    const totalPages = Math.ceil(filtered.length / pageSize);
    if (currentPage > totalPages) currentPage = totalPages || 1;
    const startIndex = (currentPage - 1) * pageSize;
    const pageData = filtered.slice(startIndex, startIndex + pageSize);

    tableBody.innerHTML = "";

    if (pageData.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Aucune candidature trouvée.</td></tr>`;
      renderPaginationControls(totalPages);
      return;
    }

    pageData.forEach(c => {
      const hasResponse = !!c.reponse;
      const tr = document.createElement("tr");
      tr.classList.add("border-b", "border-gray-200");

      tr.innerHTML = `
        <td class="py-3 px-6 break-words">${c.email}</td>
        <td class="py-3 px-6 break-words"><a href="${c.site_url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">${c.site_url}</a></td>
        <td class="py-3 px-6 break-words">${c.entreprise}</td>
        <td class="py-3 px-6">${c.cv ? `<a href="${c.cv}" target="_blank" rel="noopener noreferrer" class="text-blue-500 underline">Voir CV</a>` : "-"}</td>
        <td class="py-3 px-6 whitespace-pre-wrap max-w-xs">${c.infos_entreprise || ""}</td>
        <td class="py-3 px-6 break-words">${c.email_entreprise || "-"}</td>

        <td class="py-3 px-6">${hasResponse ? " Oui" : " Non"}</td>
        <td class="py-3 px-6 space-y-1">
  ${!hasResponse ? `
    <span data-id="${c._id}" class="mark-response-btn cursor-pointer text-green-600 hover:text-green-800 underline block">Marquer réponse</span>
  ` : ""}
  <span data-letter="${encodeURIComponent(c.lettre_generee || '')}" data-id="${c._id}" class="view-letter-btn cursor-pointer text-blue-600 hover:text-blue-800 underline block">Consulter</span>
  <span data-id="${c._id}" class="delete-cand-btn cursor-pointer text-red-600 hover:text-red-800 underline block">Supprimer</span>
  <span data-id="${c._id}" class="relancer-btn cursor-pointer text-yellow-600 hover:text-yellow-800 underline block">Relancer</span>
</td>

      `;

      tableBody.appendChild(tr);
    });

    renderPaginationControls(totalPages);
    attachButtonsListeners();
  }

  // Affiche les boutons pagination
  function renderPaginationControls(totalPages) {
    paginationControls.innerHTML = `
      <button ${currentPage === 1 ? "disabled" : ""} class="px-3 py-1 bg-gray-300 rounded disabled:opacity-50" id="prevPageBtn">Précédent</button>
      <span>Page ${currentPage} / ${totalPages || 1}</span>
      <button ${currentPage === totalPages ? "disabled" : ""} class="px-3 py-1 bg-gray-300 rounded disabled:opacity-50" id="nextPageBtn">Suivant</button>
    `;

    document.getElementById("prevPageBtn").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable(candidaturesData);
      }
    });

    document.getElementById("nextPageBtn").addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTable(candidaturesData);
      }
    });
  }

  // Attache listeners aux boutons du tableau
  function attachButtonsListeners() {
    document.querySelectorAll(".mark-response-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-id");
        try {
          const res = await fetch(`${apiBase}/${id}/mark-response`, { method: "POST" });
          if (!res.ok) throw new Error();
          showMessage("Candidature marquée comme répondue", "success");
          fetchCandidatures();
        } catch {
          showMessage("Erreur lors de la mise à jour", "error");
        }
      });
    });

    document.querySelectorAll(".delete-cand-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-id");
        if (confirm("Supprimer cette candidature ?")) {
          try {
            const res = await fetch(`${apiBase}/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error();
            showMessage("Candidature supprimée", "success");
            fetchCandidatures();
          } catch {
            showMessage("Erreur lors de la suppression", "error");
          }
        }
      });
    });

    // Affiche la lettre dans la modale
    document.querySelectorAll(".view-letter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const lettreEncoded = btn.getAttribute("data-letter") || "";
        const lettre = decodeURIComponent(lettreEncoded);
        openLetterModal(lettre);
      });
    });

    document.querySelectorAll(".relancer-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.getAttribute("data-id");
    if (!confirm("Envoyer une relance à l'entreprise ?")) return;

    try {
      const res = await fetch(`${apiBase}/${id}/relancer`, { method: "POST" });
      if (!res.ok) throw new Error();
      showMessage("Relance envoyée avec succès", "success");
    } catch (err) {
      showMessage("Erreur lors de l’envoi de la relance", "error");
    }
  });
});

  }

  // Filtrage live
  filterCheckbox.addEventListener("change", () => {
    currentPage = 1;
    renderTable(candidaturesData);
  });

  // Initial fetch
  fetchCandidatures();

</script>
</body>
</html>
